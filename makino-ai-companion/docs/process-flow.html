<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰§é‡ç”Ÿä¿å¡¾ AIä¼´èµ°ã‚·ã‚¹ãƒ†ãƒ  - ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼å›³</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
            background: #f5f7fa;
            color: #1a1a2e;
            line-height: 1.6;
        }
        .page-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 32px 40px;
        }
        .page-header h1 { font-size: 24px; font-weight: 700; }
        .page-header p { font-size: 14px; color: #a0aec0; margin-top: 4px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }

        .section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            margin-bottom: 32px;
            overflow: hidden;
        }
        .section-header {
            padding: 20px 28px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-number {
            width: 32px; height: 32px;
            background: #1a1a2e;
            color: #fff;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
            flex-shrink: 0;
        }
        .section-header h2 { font-size: 18px; font-weight: 600; }
        .section-desc {
            font-size: 13px; color: #718096;
            padding: 12px 28px 0;
        }
        .section-body { padding: 20px 28px 28px; }

        .mermaid { display: flex; justify-content: center; }
        .mermaid svg { max-width: 100%; height: auto; }

        .legend {
            display: flex; flex-wrap: wrap; gap: 16px;
            padding: 16px 28px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 13px;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color {
            width: 14px; height: 14px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .file-ref {
            font-size: 12px;
            color: #a0aec0;
            padding: 8px 28px 16px;
        }
        .file-ref code {
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }

        .table-section { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        th {
            background: #f7fafc;
            text-align: left;
            padding: 10px 16px;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
            white-space: nowrap;
        }
        td {
            padding: 10px 16px;
            border-bottom: 1px solid #edf2f7;
        }
        td code {
            background: #edf2f7;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container { padding: 16px 12px; }
            .section-body { padding: 12px 16px 20px; }
            .section-header { padding: 16px; }
        }
    </style>
</head>
<body>

<div class="page-header">
    <h1>ç‰§é‡ç”Ÿä¿å¡¾ AIä¼´èµ°ã‚·ã‚¹ãƒ†ãƒ  - ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ãƒ­ãƒ¼å›³</h1>
    <p>å…¥åŠ› â†’ å‡¦ç† â†’ å‡ºåŠ› â†’ ãƒ‡ãƒ¼ã‚¿æ ¼ç´ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼</p>
</div>

<div class="container">

    <!-- ===== 1. å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">1</span>
            <h2>å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦³</h2>
        </div>
        <p class="section-desc">ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹æˆã™ã‚‹å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã€ãƒ‡ãƒ¼ã‚¿ã®æµã‚Œæ–¹å‘ã‚’ç¤ºã™ã€‚</p>
        <div class="section-body">
            <pre class="mermaid">
graph TB
    subgraph USER["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰"]
        UI_MAIN["index.html<br/>ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³UI"]
        UI_WIDGET["widget.html<br/>åŸ‹ã‚è¾¼ã¿ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ"]
    end

    subgraph FRONTEND["ğŸ“± ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆstatic/js/chat.jsï¼‰"]
        FREE_INPUT["è‡ªç”±å…¥åŠ›<br/>ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼‰"]
        GUIDE_NAV["è³ªå•ãƒŠãƒ“<br/>ï¼ˆå¤šæ®µéšé¸æŠï¼‰"]
        DISPLAY["ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º<br/>ï¼‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯UI"]
    end

    subgraph API["âš¡ FastAPIï¼ˆapp.py + src/api/routes.pyï¼‰"]
        EP_CHAT["POST /api/chat"]
        EP_GUIDE["POST /api/guide/suggestions"]
        EP_FEEDBACK["POST /api/feedback"]
        EP_METRICS["GET /api/metrics"]
    end

    subgraph ENGINE["ğŸ§  ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆsrc/chat/engine.pyï¼‰"]
        RAG["RAGæ¤œç´¢<br/>ï¼ˆsrc/chat/rag.pyï¼‰"]
        ESCALATION["ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®š"]
        PROMPT_BUILD["ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰<br/>ï¼ˆsrc/prompts/ï¼‰"]
        CLAUDE_CALL["Claude API å‘¼ã³å‡ºã—"]
    end

    subgraph DATA["ğŸ’¾ ãƒ‡ãƒ¼ã‚¿å±¤"]
        KNOWLEDGE[("knowledge/<br/>Markdown + YAML<br/>ï¼ˆãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ï¼‰")]
        SQLITE[("SQLite<br/>conversations.db")]
        CSV_EXPORT["CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ<br/>ï¼ˆscripts/export_logs.pyï¼‰"]
    end

    subgraph EXTERNAL["â˜ï¸ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹"]
        CLAUDE_API["Anthropic Claude API"]
    end

    UI_MAIN --> FREE_INPUT
    UI_MAIN --> GUIDE_NAV
    UI_WIDGET --> FREE_INPUT
    UI_WIDGET --> GUIDE_NAV

    FREE_INPUT -->|"è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ"| EP_CHAT
    GUIDE_NAV -->|"æ§‹ç¯‰ã•ã‚ŒãŸè³ªå•"| EP_CHAT
    GUIDE_NAV -->|"ã‚«ãƒ†ã‚´ãƒªæƒ…å ±"| EP_GUIDE
    DISPLAY -->|"ğŸ‘ğŸ‘ è©•ä¾¡"| EP_FEEDBACK

    EP_CHAT --> RAG
    EP_GUIDE -->|"è»½é‡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ"| CLAUDE_API

    RAG -->|"ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢"| KNOWLEDGE
    RAG -->|"é–¢é€£ãƒãƒ£ãƒ³ã‚¯"| ESCALATION
    ESCALATION -->|"OK"| PROMPT_BUILD
    PROMPT_BUILD -->|"system + messages"| CLAUDE_CALL
    CLAUDE_CALL -->|"API ãƒªã‚¯ã‚¨ã‚¹ãƒˆ"| CLAUDE_API
    CLAUDE_API -->|"å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ"| CLAUDE_CALL

    EP_CHAT -->|"ä¼šè©±ãƒ­ã‚°ä¿å­˜"| SQLITE
    EP_FEEDBACK -->|"ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¿å­˜"| SQLITE
    ESCALATION -->|"ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¿å­˜"| SQLITE

    SQLITE -->|"å®šæœŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"| CSV_EXPORT

    EP_CHAT -->|"JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹"| DISPLAY
    EP_GUIDE -->|"ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯å€™è£œ"| GUIDE_NAV

    style USER fill:#e8f4fd,stroke:#3182ce
    style FRONTEND fill:#ebf8ff,stroke:#63b3ed
    style API fill:#fefcbf,stroke:#d69e2e
    style ENGINE fill:#fed7e2,stroke:#e53e6e
    style DATA fill:#c6f6d5,stroke:#38a169
    style EXTERNAL fill:#e9d8fd,stroke:#805ad5
            </pre>
        </div>
        <div class="legend">
            <div class="legend-item"><div class="legend-color" style="background:#e8f4fd;border:1px solid #3182ce"></div>ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
            <div class="legend-item"><div class="legend-color" style="background:#ebf8ff;border:1px solid #63b3ed"></div>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</div>
            <div class="legend-item"><div class="legend-color" style="background:#fefcbf;border:1px solid #d69e2e"></div>APIå±¤</div>
            <div class="legend-item"><div class="legend-color" style="background:#fed7e2;border:1px solid #e53e6e"></div>ã‚¨ãƒ³ã‚¸ãƒ³å±¤</div>
            <div class="legend-item"><div class="legend-color" style="background:#c6f6d5;border:1px solid #38a169"></div>ãƒ‡ãƒ¼ã‚¿å±¤</div>
            <div class="legend-item"><div class="legend-color" style="background:#e9d8fd;border:1px solid #805ad5"></div>å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹</div>
        </div>
    </div>

    <!-- ===== 2. ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">2</span>
            <h2>ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ï¼ˆè‡ªç”±å…¥åŠ› â†’ å›ç­”è¡¨ç¤ºï¼‰</h2>
        </div>
        <p class="section-desc">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³ªå•ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰å›ç­”ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã®è©³ç´°ãªå‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã€‚</p>
        <div class="section-body">
            <pre class="mermaid">
flowchart TD
    A["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³ªå•ã‚’å…¥åŠ›"] --> B["ğŸ“¤ sendMessage()"]
    B --> B1["ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤"]
    B1 --> B2["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º"]
    B2 --> B3["ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º"]
    B3 --> C["POST /api/chat<br/>{ question, pattern, session_id }"]

    C --> D["routes.py: chat()"]
    D --> D1["session_id ç”Ÿæˆ<br/>ï¼ˆæœªæŒ‡å®šæ™‚: uuid4[:8]ï¼‰"]
    D1 --> D2["get_conversation_history()<br/>SQLite ã‹ã‚‰ä¼šè©±å±¥æ­´å–å¾—"]
    D2 --> E["engine.chat() å‘¼ã³å‡ºã—"]

    E --> F["RAGæ¤œç´¢<br/>rag.search(question)"]
    F --> F1["SimpleRAG: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°<br/>å…¨ãƒãƒ£ãƒ³ã‚¯ã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°"]
    F1 --> F2["ä¸Šä½5ä»¶ã® SearchResult ã‚’è¿”å´"]

    F2 --> G{"ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³<br/>åˆ¤å®š"}
    G -->|"å¼·åˆ¶ã‚«ãƒ†ã‚´ãƒªè©²å½“<br/>ï¼ˆã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ç­‰ï¼‰"| H["ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¿œç­”ã‚’è¿”å´"]
    G -->|"æ¤œç´¢çµæœãªã—"| H
    G -->|"ç¢ºä¿¡åº¦ < 0.3"| H
    G -->|"é€šå¸¸"| I["ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰"]

    H --> H1["save_conversation()<br/>escalated=True"]
    H1 --> H2["save_escalation()<br/>reason ã‚’è¨˜éŒ²"]
    H2 --> H3["ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”å´"]

    I --> I1["build_system_prompt(pattern, persona)"]
    I1 --> I2["ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ<br/>ï¼ˆPATTERN_1ã€œ4_SYSTEM_PROMPTï¼‰"]
    I2 --> I3["äººæ ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŒ¿å…¥<br/>ï¼ˆpersona_config.yamlï¼‰"]
    I3 --> I4["RAGã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½è¨˜<br/>ï¼ˆå‚ç…§ãƒŠãƒ¬ãƒƒã‚¸ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰"]

    I4 --> J["ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—æ§‹ç¯‰"]
    J --> J1["ä¼šè©±å±¥æ­´ï¼ˆç›´è¿‘10ä»¶ï¼‰ã‚’<br/>user/assistantäº¤äº’ã«è¿½åŠ "]
    J1 --> J2["ä»Šå›ã®è³ªå•ã‚’æœ«å°¾ã«è¿½åŠ "]

    J2 --> K["â˜ï¸ Claude API å‘¼ã³å‡ºã—<br/>client.messages.create()"]
    K --> K1["model: claude-sonnet-4-5<br/>max_tokens: 4096<br/>system: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ<br/>messages: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…åˆ—"]

    K1 --> L["ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†"]
    L --> L1["answer = response.content[0].text"]
    L1 --> L2["tokens_used = input + output tokens"]
    L2 --> L3["confidence = RAGã‚¹ã‚³ã‚¢å¹³å‡å€¤"]
    L3 --> L4["category = ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç°¡æ˜“åˆ†é¡"]

    L4 --> M["save_conversation()<br/>SQLite conversations ãƒ†ãƒ¼ãƒ–ãƒ«"]
    M --> N["ChatResponse ã‚’è¿”å´"]

    N --> O["JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰"]
    O --> P["ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é™¤å»"]
    P --> Q["appendMessage('assistant', answer)"]
    Q --> Q1["å›ç­”ãƒãƒ–ãƒ«è¡¨ç¤º"]
    Q1 --> Q2["å‡ºå…¸è¡¨ç¤ºï¼ˆdetails/summaryï¼‰"]
    Q2 --> Q3["ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³è¡¨ç¤º<br/>ï¼ˆğŸ‘ğŸ‘ï¼‰"]

    H3 --> O

    style A fill:#e8f4fd,stroke:#3182ce
    style K fill:#e9d8fd,stroke:#805ad5
    style K1 fill:#e9d8fd,stroke:#805ad5
    style M fill:#c6f6d5,stroke:#38a169
    style H1 fill:#c6f6d5,stroke:#38a169
    style H2 fill:#c6f6d5,stroke:#38a169
    style G fill:#fefcbf,stroke:#d69e2e
    style Q1 fill:#ebf8ff,stroke:#63b3ed
    style Q2 fill:#ebf8ff,stroke:#63b3ed
    style Q3 fill:#ebf8ff,stroke:#63b3ed
            </pre>
        </div>
        <div class="file-ref">
            é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«:
            <code>static/js/chat.js</code>
            <code>src/api/routes.py</code>
            <code>src/chat/engine.py</code>
            <code>src/chat/rag.py</code>
            <code>src/prompts/system_prompts.py</code>
            <code>src/database/operations.py</code>
        </div>
    </div>

    <!-- ===== 3. è³ªå•ãƒŠãƒ“ãƒ•ãƒ­ãƒ¼ ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">3</span>
            <h2>è³ªå•ãƒŠãƒ“ãƒ•ãƒ­ãƒ¼ï¼ˆã‚¬ã‚¤ãƒ‰ä»˜ãå…¥åŠ› â†’ è³ªå•ç”Ÿæˆï¼‰</h2>
        </div>
        <p class="section-desc">è³ªå•ãƒŠãƒ“ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§è³ªå•ãŒçµ„ã¿ç«‹ã¦ã‚‰ã‚Œã€æœ€çµ‚çš„ã«ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã«åˆæµã™ã‚‹æµã‚Œã€‚</p>
        <div class="section-body">
            <pre class="mermaid">
flowchart TD
    START["ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ<br/>? ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"] --> OPEN["toggleGuide() â†’ openGuide()"]
    OPEN --> CHECK{"patternSelect<br/>ã®å€¤ã¯ï¼Ÿ"}

    CHECK -->|"Pattern 4<br/>ï¼ˆåŠ±ã¾ã—ï¼‰"| P4MSG["ã€Œè‡ªç”±ã«ãŠæ°—æŒã¡ã‚’<br/>ãŠèã‹ã›ãã ã•ã„ã€è¡¨ç¤º"]

    CHECK -->|"Pattern 1ã€œ3"| STEP0

    subgraph STEP0_BOX["Step 0: ã‚«ãƒ†ã‚´ãƒªé¸æŠï¼ˆé™çš„ï¼‰"]
        STEP0["GUIDE_CATEGORIES[pattern]<br/>ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªä¸€è¦§è¡¨ç¤º"]
        STEP0 --> CAT_BTN["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚«ãƒ†ã‚´ãƒªã‚’<br/>ãƒœã‚¿ãƒ³ã§é¸æŠ"]
    end

    CAT_BTN --> STEP1

    subgraph STEP1_BOX["Step 1: ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯é¸æŠï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰"]
        STEP1["é™çš„ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª<br/>ã‚’å³æ™‚è¡¨ç¤º"]
        STEP1 --> AI_FETCH["fetchAiSuggestions()<br/>éåŒæœŸã§å®Ÿè¡Œ"]
        AI_FETCH --> API_CALL["POST /api/guide/suggestions<br/>{ pattern, category }"]
        API_CALL --> CLAUDE_GUIDE["â˜ï¸ Claude API<br/>ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯6ä»¶ç”Ÿæˆ"]
        CLAUDE_GUIDE --> AI_OK{"AIç”Ÿæˆ<br/>æˆåŠŸï¼Ÿ"}
        AI_OK -->|"æˆåŠŸ"| REPLACE["AIç”Ÿæˆã®é¸æŠè‚¢ã§<br/>ãƒ‘ãƒãƒ«ã‚’å†æç”»"]
        AI_OK -->|"å¤±æ•—"| FALLBACK["é™çš„ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª<br/>ã®ã¾ã¾ç¶­æŒ"]
        REPLACE --> SUB_SELECT["ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯é¸æŠ"]
        FALLBACK --> SUB_SELECT
    end

    SUB_SELECT --> STEP2

    subgraph STEP2_BOX["Step 2: ç¢ºèª + è£œè¶³ + é€ä¿¡"]
        STEP2["ã‚µãƒãƒªãƒ¼è¡¨ç¤º<br/>ãƒ†ãƒ¼ãƒ â€º ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯"]
        STEP2 --> FREE["è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›<br/>ï¼ˆä»»æ„ï¼‰"]
        FREE --> SUBMIT["ã€Œã“ã®å†…å®¹ã§è³ªå•ã™ã‚‹ã€<br/>ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"]
    end

    SUBMIT --> BUILD["buildGuideQuestion()"]
    BUILD --> BUILD_Q{"è£œè¶³ãƒ†ã‚­ã‚¹ãƒˆ<br/>ã‚ã‚Šï¼Ÿ"}
    BUILD_Q -->|"ã‚ã‚Š"| Q_WITH["ã€Œ{ã‚«ãƒ†ã‚´ãƒª}ã®{ã‚µãƒ–}ã«<br/>ã¤ã„ã¦è³ªå•ã§ã™ã€‚{è£œè¶³}ã€"]
    BUILD_Q -->|"ãªã—"| Q_WITHOUT["ã€Œ{ã‚«ãƒ†ã‚´ãƒª}ã®{ã‚µãƒ–}ã«<br/>ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€‚ã€"]

    Q_WITH --> SEND["sendMessage(question)<br/>â†’ ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆãƒ•ãƒ­ãƒ¼ã¸åˆæµ"]
    Q_WITHOUT --> SEND

    SEND --> CLOSE["closeGuide()<br/>ã‚¬ã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹"]

    style START fill:#e8f4fd,stroke:#3182ce
    style STEP0_BOX fill:#fff5f5,stroke:#fc8181,stroke-width:2px
    style STEP1_BOX fill:#fffff0,stroke:#ecc94b,stroke-width:2px
    style STEP2_BOX fill:#f0fff4,stroke:#68d391,stroke-width:2px
    style CLAUDE_GUIDE fill:#e9d8fd,stroke:#805ad5
    style SEND fill:#fefcbf,stroke:#d69e2e
            </pre>
        </div>
        <div class="file-ref">
            é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«:
            <code>static/js/chat.js</code>ï¼ˆGUIDE_CATEGORIES, renderGuideStep, fetchAiSuggestions, buildGuideQuestionï¼‰
            <code>src/api/routes.py</code>ï¼ˆguide_suggestions ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
        </div>
    </div>

    <!-- ===== 4. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">4</span>
            <h2>ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆSQLite æ›¸ãè¾¼ã¿ãƒ»èª­ã¿å–ã‚Šï¼‰</h2>
        </div>
        <p class="section-desc">ã©ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿ã€ã©ã“ã‹ã‚‰èª­ã¿å–ã‚‹ã‹ã®å…¨ä½“åƒã€‚</p>
        <div class="section-body">
            <pre class="mermaid">
flowchart LR
    subgraph WRITE["âœï¸ æ›¸ãè¾¼ã¿"]
        W1["POST /api/chat"]
        W2["POST /api/feedback"]
        W3["ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®š"]
    end

    subgraph SQLITE["ğŸ’¾ SQLiteï¼ˆconversations.dbï¼‰"]
        T1[("conversations<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>id, timestamp<br/>session_id, user_id<br/>bot_pattern<br/>question, answer<br/>sources_used<br/>confidence<br/>escalated, category<br/>tokens_used")]
        T2[("feedback<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>id, conversation_id<br/>timestamp<br/>rating (good/bad)<br/>comment")]
        T3[("escalations<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>id, conversation_id<br/>timestamp, reason<br/>status, assigned_to<br/>resolution<br/>resolved_at")]
        T4[("knowledge_updates<br/>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>id, timestamp<br/>file_path, action<br/>commit_hash<br/>description")]
    end

    subgraph READ["ğŸ“– èª­ã¿å–ã‚Š"]
        R1["GET /api/metrics"]
        R2["GET /api/metrics/patterns"]
        R3["ä¼šè©±å±¥æ­´å–å¾—<br/>ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šæ™‚ï¼‰"]
        R4["scripts/export_logs.py<br/>â†’ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"]
    end

    W1 -->|"save_conversation()"| T1
    W2 -->|"save_feedback()"| T2
    W3 -->|"save_escalation()"| T3

    T1 --> R1
    T2 --> R1
    T1 --> R2
    T1 --> R3
    T1 --> R4
    T2 --> R4

    style WRITE fill:#fed7e2,stroke:#e53e6e
    style SQLITE fill:#c6f6d5,stroke:#38a169
    style READ fill:#ebf8ff,stroke:#63b3ed
            </pre>
        </div>
    </div>

    <!-- ===== 5. RAGå‡¦ç†ã®è©³ç´° ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">5</span>
            <h2>RAGå‡¦ç†ï¼ˆãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ â†’ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆï¼‰</h2>
        </div>
        <p class="section-desc">MarkdownãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ãŒRAGæ¤œç´¢ã§ã©ã†å‡¦ç†ã•ã‚Œã€Claude APIã«æ¸¡ã•ã‚Œã‚‹ã¾ã§ã€‚</p>
        <div class="section-body">
            <pre class="mermaid">
flowchart TD
    subgraph INIT["ğŸ”„ èµ·å‹•æ™‚ï¼ˆ1å›ã®ã¿ï¼‰"]
        KB["knowledge/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª<br/>ï¼ˆMarkdown + YAML frontmatterï¼‰"]
        KB --> LOAD["KnowledgeLoader.load_all()"]
        LOAD --> SCAN["*.md ã‚’å†å¸°ã‚¹ã‚­ãƒ£ãƒ³"]
        SCAN --> PARSE["å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†"]
        PARSE --> META["ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼æŠ½å‡º<br/>ï¼ˆYAML ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰"]
        META --> SPLIT["ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†å‰²<br/>ï¼ˆ## è¦‹å‡ºã—å˜ä½ï¼‰"]
        SPLIT --> CHUNK["ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²<br/>ï¼ˆ500æ–‡å­—ã€50æ–‡å­—ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—ï¼‰"]
        CHUNK --> STORE["KnowledgeChunk ãƒªã‚¹ãƒˆ<br/>ã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒ"]
        STORE --> RAG_INIT["SimpleRAG(chunks)<br/>åˆæœŸåŒ–å®Œäº†"]
    end

    subgraph SEARCH["ğŸ” è³ªå•ã”ã¨ï¼ˆæ¯å›ï¼‰"]
        QUERY["ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ"]
        QUERY --> TERMS["ã‚¯ã‚¨ãƒªã‚’ãƒˆãƒ¼ã‚¯ãƒ³åˆ†å‰²<br/>ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š lowercaseï¼‰"]
        TERMS --> SCORE["å…¨ãƒãƒ£ãƒ³ã‚¯ã«å¯¾ã—ã¦<br/>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢ç®—å‡º"]
        SCORE --> SORT["ã‚¹ã‚³ã‚¢é™é †ã‚½ãƒ¼ãƒˆ"]
        SORT --> TOP5["ä¸Šä½5ä»¶ã‚’ SearchResult ã¨ã—ã¦è¿”å´"]
    end

    subgraph FORMAT["ğŸ“ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢"]
        TOP5 --> FMT["format_context()"]
        FMT --> CTX["ã€å‚ç…§1ã€‘å‡ºå…¸: xxx.md<br/>ï¼ˆãƒãƒ£ãƒ³ã‚¯å†…å®¹ï¼‰<br/>â”€â”€â”€<br/>ã€å‚ç…§2ã€‘å‡ºå…¸: yyy.md<br/>ï¼ˆãƒãƒ£ãƒ³ã‚¯å†…å®¹ï¼‰"]
        CTX --> INJECT["ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®<br/>ã€Œ## å‚ç…§ãƒŠãƒ¬ãƒƒã‚¸ã€<br/>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½è¨˜"]
    end

    TOP5 --> SRC["get_sources()"]
    SRC --> SRC_LIST["å‡ºå…¸ãƒ•ã‚¡ã‚¤ãƒ«åãƒªã‚¹ãƒˆ<br/>ï¼ˆé‡è¤‡é™¤å»æ¸ˆã¿ï¼‰"]
    SRC_LIST --> RESP["ChatResponse.sources<br/>â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å‡ºå…¸è¡¨ç¤º"]

    TOP5 --> CONF["_estimate_confidence()"]
    CONF --> CONF_VAL["å¹³å‡ã‚¹ã‚³ã‚¢<br/>= ç¢ºä¿¡åº¦ï¼ˆ0.0ã€œ1.0ï¼‰"]

    style INIT fill:#f0fff4,stroke:#38a169,stroke-width:2px
    style SEARCH fill:#fffff0,stroke:#ecc94b,stroke-width:2px
    style FORMAT fill:#ebf8ff,stroke:#63b3ed,stroke-width:2px
            </pre>
        </div>
        <div class="file-ref">
            é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«:
            <code>src/chat/rag.py</code>ï¼ˆKnowledgeLoader, SimpleRAGï¼‰
            <code>knowledge/</code>ï¼ˆãƒŠãƒ¬ãƒƒã‚¸Markdownãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ï¼‰
        </div>
    </div>

    <!-- ===== 6. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼†ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">6</span>
            <h2>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ â†’ KPI ãƒ¡ãƒˆãƒªã‚¯ã‚¹ â†’ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h2>
        </div>
        <p class="section-desc">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©•ä¾¡ã®è¨˜éŒ²ã‹ã‚‰ã€KPIé›†è¨ˆã€å®šæœŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¾ã§ã®ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ãƒ•ãƒ­ãƒ¼ã€‚</p>
        <div class="section-body">
            <pre class="mermaid">
flowchart LR
    FB_BTN["ğŸ‘ / ğŸ‘<br/>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³"] --> FB_POST["POST /api/feedback<br/>{ conversation_id, rating }"]
    FB_POST --> FB_SAVE["save_feedback()<br/>â†’ feedback ãƒ†ãƒ¼ãƒ–ãƒ«"]

    FB_SAVE --> METRICS
    CONV_SAVE["conversations ãƒ†ãƒ¼ãƒ–ãƒ«<br/>ï¼ˆãƒãƒ£ãƒƒãƒˆæ™‚ã«è‡ªå‹•ä¿å­˜ï¼‰"] --> METRICS

    subgraph METRICS["ğŸ“Š KPIé›†è¨ˆï¼ˆGET /api/metricsï¼‰"]
        M1["total_questions<br/>ç·è³ªå•æ•°"]
        M2["answer_success_rate<br/>è‡ªåŠ›å›ç­”ç‡"]
        M3["average_confidence<br/>å¹³å‡ç¢ºä¿¡åº¦"]
        M4["escalation_count / rate<br/>ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°ãƒ»ç‡"]
        M5["user_satisfaction<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦"]
    end

    CONV_SAVE --> PATTERN_M
    subgraph PATTERN_M["ğŸ“Š ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥é›†è¨ˆ"]
        PM1["GET /api/metrics/patterns"]
        PM1 --> PM2["Pattern 1ã€œ4 ã”ã¨ã®<br/>ä»¶æ•°ãƒ»ç¢ºä¿¡åº¦ãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ç‡"]
    end

    CONV_SAVE --> EXPORT
    FB_SAVE --> EXPORT
    subgraph EXPORT["ğŸ“¤ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"]
        EX1["scripts/export_logs.py"]
        EX1 --> EX2["conversations + feedback<br/>ã‚’ LEFT JOIN"]
        EX2 --> EX3["logs/exports/<br/>conversations_YYYYMMDD.csv"]
    end

    style FB_BTN fill:#e8f4fd,stroke:#3182ce
    style METRICS fill:#fefcbf,stroke:#d69e2e,stroke-width:2px
    style PATTERN_M fill:#fefcbf,stroke:#d69e2e,stroke-width:2px
    style EXPORT fill:#c6f6d5,stroke:#38a169,stroke-width:2px
            </pre>
        </div>
    </div>

    <!-- ===== 7. ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œè¡¨ ===== -->
    <div class="section">
        <div class="section-header">
            <span class="section-number">7</span>
            <h2>ãƒ•ã‚¡ã‚¤ãƒ« Ã— å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ— å¯¾å¿œè¡¨</h2>
        </div>
        <div class="section-body table-section">
            <table>
                <thead>
                    <tr>
                        <th>å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—</th>
                        <th>æ‹…å½“ãƒ•ã‚¡ã‚¤ãƒ«</th>
                        <th>ä¸»è¦é–¢æ•° / ã‚¯ãƒ©ã‚¹</th>
                        <th>å…¥åŠ›</th>
                        <th>å‡ºåŠ›</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>UIè¡¨ç¤ºãƒ»å…¥åŠ›å—ä»˜</td>
                        <td><code>templates/index.html</code><br/><code>static/js/chat.js</code></td>
                        <td><code>sendMessage()</code></td>
                        <td>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ</td>
                        <td>POST /api/chat ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</td>
                    </tr>
                    <tr>
                        <td>è³ªå•ãƒŠãƒ“ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆï¼‰</td>
                        <td><code>static/js/chat.js</code></td>
                        <td><code>renderGuideStep()</code><br/><code>buildGuideQuestion()</code></td>
                        <td>ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯é¸æŠ</td>
                        <td>æ§‹ç¯‰ã•ã‚ŒãŸè³ªå•ãƒ†ã‚­ã‚¹ãƒˆ</td>
                    </tr>
                    <tr>
                        <td>è³ªå•ãƒŠãƒ“ï¼ˆAIç”Ÿæˆï¼‰</td>
                        <td><code>src/api/routes.py</code></td>
                        <td><code>guide_suggestions()</code></td>
                        <td>pattern, category</td>
                        <td>suggestions[]ï¼ˆã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯å€™è£œï¼‰</td>
                    </tr>
                    <tr>
                        <td>APIå—ä»˜ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</td>
                        <td><code>src/api/routes.py</code></td>
                        <td><code>chat()</code></td>
                        <td>ChatRequestï¼ˆquestion, pattern, session_idï¼‰</td>
                        <td>ChatResponseModel</td>
                    </tr>
                    <tr>
                        <td>ä¼šè©±å±¥æ­´å–å¾—</td>
                        <td><code>src/database/operations.py</code></td>
                        <td><code>get_conversation_history()</code></td>
                        <td>session_id</td>
                        <td>ç›´è¿‘20ä»¶ã® Q&A ãƒªã‚¹ãƒˆ</td>
                    </tr>
                    <tr>
                        <td>RAGæ¤œç´¢</td>
                        <td><code>src/chat/rag.py</code></td>
                        <td><code>SimpleRAG.search()</code></td>
                        <td>è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ</td>
                        <td>SearchResult Ã— 5ï¼ˆã‚¹ã‚³ã‚¢ä»˜ãï¼‰</td>
                    </tr>
                    <tr>
                        <td>ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ¤å®š</td>
                        <td><code>src/chat/engine.py</code></td>
                        <td><code>_check_escalation()</code></td>
                        <td>è³ªå• + æ¤œç´¢çµæœ</td>
                        <td>(should_escalate, reason)</td>
                    </tr>
                    <tr>
                        <td>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰</td>
                        <td><code>src/prompts/system_prompts.py</code></td>
                        <td><code>build_system_prompt()</code></td>
                        <td>pattern, persona_config</td>
                        <td>å®Œæˆã—ãŸã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ–‡å­—åˆ—</td>
                    </tr>
                    <tr>
                        <td>Claude APIå‘¼ã³å‡ºã—</td>
                        <td><code>src/chat/engine.py</code></td>
                        <td><code>client.messages.create()</code></td>
                        <td>system + messages + model + max_tokens</td>
                        <td>å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ + ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡</td>
                    </tr>
                    <tr>
                        <td>DBä¿å­˜</td>
                        <td><code>src/database/operations.py</code></td>
                        <td><code>save_conversation()</code><br/><code>save_feedback()</code><br/><code>save_escalation()</code></td>
                        <td>å„ç¨®ãƒ‡ãƒ¼ã‚¿</td>
                        <td>ãƒ¬ã‚³ãƒ¼ãƒ‰ID</td>
                    </tr>
                    <tr>
                        <td>KPIé›†è¨ˆ</td>
                        <td><code>src/database/operations.py</code></td>
                        <td><code>calculate_metrics()</code></td>
                        <td>æ—¥ä»˜ç¯„å›²ï¼ˆä»»æ„ï¼‰</td>
                        <td>å›ç­”ç‡ãƒ»ç¢ºä¿¡åº¦ãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ç‡ãƒ»æº€è¶³åº¦</td>
                    </tr>
                    <tr>
                        <td>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</td>
                        <td><code>scripts/export_logs.py</code></td>
                        <td><code>export_to_csv()</code></td>
                        <td>SQLiteãƒ‡ãƒ¼ã‚¿</td>
                        <td>logs/exports/xxx.csv</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis',
            padding: 16,
            nodeSpacing: 30,
            rankSpacing: 40,
        },
        themeVariables: {
            fontFamily: '"Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif',
            fontSize: '13px',
        },
    });
</script>

</body>
</html>
